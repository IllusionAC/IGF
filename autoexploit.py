from os import path
from colorama import Fore, Back, Style
from fake_useragent import UserAgent
from googlesearch import search
import os, sys, subprocess, re
    
"""
      /$$$$$$  /$$                 /$$   /$$$                               /$$           /$$   /$$             /$$$  
     /$$__  $$|__/                | $$  /$$_/                              | $$          |__/  | $$            |_  $$ 
    | $$  \__/ /$$ /$$$$$$$   /$$$$$$$ /$$/    /$$$$$$  /$$   /$$  /$$$$$$ | $$  /$$$$$$  /$$ /$$$$$$   /$$$$$$$ \  $$
    | $$$$    | $$| $$__  $$ /$$__  $$| $$    /$$__  $$|  $$ /$$/ /$$__  $$| $$ /$$__  $$| $$|_  $$_/  /$$_____/  | $$
    | $$_/    | $$| $$  \ $$| $$  | $$| $$   | $$$$$$$$ \  $$$$/ | $$  \ $$| $$| $$  \ $$| $$  | $$   |  $$$$$$   | $$
    | $$      | $$| $$  | $$| $$  | $$|  $$  | $$_____/  >$$  $$ | $$  | $$| $$| $$  | $$| $$  | $$ /$$\____  $$  /$$/
 /$$| $$      | $$| $$  | $$|  $$$$$$$ \  $$$|  $$$$$$$ /$$/\  $$| $$$$$$$/| $$|  $$$$$$/| $$  |  $$$$//$$$$$$$//$$$/ 
|__/|__/      |__/|__/  |__/ \_______/  \___/ \_______/|__/  \__/| $$____/ |__/ \______/ |__/   \___/ |_______/|___/  
                                                                 | $$                                                 
                                                                 | $$        v 1.0                                         
                                                                 |__/    By: c0deninja

"""

# script has to be in the same directory as Windows-Exploit-Suggester

if path.exists('Windows-Exploit-Suggester'):
    pass
if not path.exists('Windows-Exploit-Suggester'):
    print (Fore.RED + "Windows Exploit Suggester is not here!\n")
    install = input("Do you want to clone it from github?? y/n: ").lower()
    if install == "y":
        os.system("git clone https://github.com/AonCyberLabs/Windows-Exploit-Suggester.git")
        if path.exists('Windows-Exploit-Suggester'):
            print (Fore.GREEN + "Windows Exploit Suggester cloned!\n")
            print (Fore.GREEN + "Updating the  database...\n")
            os.system("python windows-exploit-suggester.py --update")
            print ("Done updating!\n")  
        if not path.exists("Couldn't find the Windows-Exploit-Suggester directory"):
            sys.exit(1)
    elif install == "n":
        sys.exit(1)
print ("============== Windows Exploit Suggester ==============\n")
directory = 'Windows-Exploit-Suggester'
dbsfile = os.listdir(directory)
for files in dbsfile:
    if files.endswith(".xls"):
        files = files.strip()
        dbsfilepath = os.path.abspath(os.getcwd())
        systeminfo = dbsfilepath + "/" + directory + "/" + 'systeminfo.txt'
        files = dbsfilepath + "/" + directory + "/" + files
        print (Fore.GREEN + "Found: {}\n".format(files))
        cmd = "python {}/Windows-Exploit-Suggester/windows-exploit-suggester.py -u --database {} --system {}".format(dbsfilepath, files, systeminfo)
        p = subprocess.Popen(cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.STDOUT)
        out, err = p.communicate()
        out = out.decode()
        print (out)
        with open('exploits.txt', 'w') as f:
            f.writelines(str(out.replace("[1;34m[*][0;0m", '')))

print ("=============== SearchSPloit ================\n")

os.system('grep -riI1 "MS" exploits.txt | sed "s/\^.*\\(MS.*:\).*$/\\1/" > sploitsearch.txt')
os.system("sed '/^[[:space:]]*$/d' sploitsearch.txt")

with open('sploitsearch.txt', 'r') as mytest:
    data = mytest.readlines()[1:]

for i in data:
    if not i.isspace():
        i = i.replace(":", "")
        i = i.strip()
        os.system("searchsploit {}".format(i))